x-common-resources: &common-resources
  deploy:
    resources:
      limits:
        cpus: '2'
        memory: 8G
      reservations:
        cpus: '1'
        memory: 4G
  ulimits:
    core: 0
  environment:
    ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"

services:
  # -------------- Base Images --------------
  symcc:
    build:
      context: .
      dockerfile: symcc-common.Dockerfile
      args:
        LLVM_VERSION: 12
    image: symcc:latest
  
  symsan:
    build:
      context: .
      dockerfile: symsan-common.Dockerfile
    image: symsan:latest
  
  concolic:
    build:
      context: .
      dockerfile: concolic-common.Dockerfile
    image: concolic:latest
  
  klee:
    build:
      context: .
      dockerfile: klee-common.Dockerfile
    image: klee:latest
  
  klee-float:
    build:
      context: .
      dockerfile: klee-float-common.Dockerfile
    image: klee-float:latest
  
  aflplusplus:
    build:
      context: .
      dockerfile: aflplusplus-common.Dockerfile
    image: aflplusplus:latest
  
  # -------------- bc --------------
  bc-symcc:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: symcc.Dockerfile
    depends_on:
      - symcc
    image: bc-symcc:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symcc", "${TIMEOUT:-60s}"]
  
  bc-symsan:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: symsan.Dockerfile
    depends_on:
      - symsan
    image: bc-symsan:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symsan", "${TIMEOUT:-60s}"]
  
  bc-concolic:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: concolic.Dockerfile
    depends_on:
      - concolic
    image: bc-concolic:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "concolic", "${TIMEOUT:-60s}"]

  bc-klee:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: klee.Dockerfile
    depends_on:
      - klee
    image: bc-klee:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee", "${TIMEOUT:-60s}"]
  
  bc-klee-pending:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: klee-pending.Dockerfile
    image: bc-klee-pending:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "klee-pending", "${TIMEOUT:-60s}"]
  
  bc-aflplusplus:
    <<: *common-resources
    build:
      context: ./bc
      dockerfile: aflplusplus.Dockerfile
    depends_on:
      - aflplusplus
    image: bc-aflplusplus:latest
    volumes:
      - ./bc/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "aflplusplus", "${TIMEOUT:-60s}"]

  # -------------- woff2 --------------
  woff2-symsan:
    <<: *common-resources
    build:
      context: ./woff2
      dockerfile: symsan.Dockerfile
    depends_on:
      - symsan
    image: woff2-symsan:latest
    volumes:
      - ./woff2/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symsan", "${TIMEOUT:-60s}"]

  woff2-symcc:
    <<: *common-resources
    build:
      context: ./woff2
      dockerfile: symcc.Dockerfile
    depends_on:
      - symcc
    image: woff2-symcc:latest
    volumes:
      - ./woff2/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "symcc", "${TIMEOUT:-60s}"]

  woff2-concolic: 
    <<: *common-resources
    build:
      context: ./woff2
      dockerfile: concolic.Dockerfile
    depends_on:
      - concolic
    image: woff2-concolic:latest
    volumes:
      - ./woff2/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "concolic", "${TIMEOUT:-60s}"]

  woff2-aflplusplus:
    <<: *common-resources
    build:
      context: ./woff2
      dockerfile: aflplusplus.Dockerfile
    depends_on:
      - aflplusplus
    image: woff2-aflplusplus:latest
    volumes:
      - ./woff2/results:/shared/:rw
    command: ["/bin/bash", "/run.sh", "aflplusplus", "${TIMEOUT:-60s}"]
  